# Kamal Configuration for Manimations
# Deploy to any server with Docker installed

service: manimations

# Docker image configuration
image: sudish80/manimations

# Server configuration
servers:
  web:
    - 192.168.1.100  # Replace with your actual server IP

# Registry configuration (Docker Hub, GitHub Container Registry, etc.)
registry:
  username: sudish80
  password:
    - KAMAL_REGISTRY_PASSWORD

# Environment variables (secrets)
env:
  secret:
    - OPENAI_API_KEY
    - GEMINI_API_KEY
    - DEEPSEEK_API_KEY
    - AWS_ACCESS_KEY_ID
    - AWS_SECRET_ACCESS_KEY
  clear:
    MANIM_QUALITY: low
    JOB_TIMEOUT: "1200"
    HOST: "0.0.0.0"
    PORT: "8000"
    PYTHONUNBUFFERED: "1"
    PYTHONDONTWRITEBYTECODE: "1"
    PYTHONOPTIMIZE: "2"

# Traefik proxy configuration
traefik:
  options:
    publish:
      - "443:443"
    volume:
      - "/letsencrypt/acme.json:/letsencrypt/acme.json"
  args:
    entryPoints.web.address: ":80"
    entryPoints.websecure.address: ":443"
    certificatesResolvers.letsencrypt.acme.email: "your-email@example.com"
    certificatesResolvers.letsencrypt.acme.storage: "/letsencrypt/acme.json"
    certificatesResolvers.letsencrypt.acme.httpchallenge: true
    certificatesResolvers.letsencrypt.acme.httpchallenge.entrypoint: web

# Accessories (optional services like Redis, PostgreSQL)
# accessories:
#   redis:
#     image: redis:7
#     host: 192.168.1.100
#     port: "6379"

# Healthcheck
healthcheck:
  path: /health
  port: 8000
  max_attempts: 10
  interval: 10s

# Volume mounts (for persistent storage)
volumes:
  - "./media:/app/media"
  - "./voice_cache:/app/voice_cache"

# Builder configuration
builder:
  multiarch: false
  args:
    RUBY_VERSION: "3.2"

# Deployment configuration
deploy:
  strategy: immediate
  rollback: fast

# SSH configuration
ssh:
  user: deploy
  port: 22
  proxy: null
  log_level: INFO

# Aliases for common commands
aliases:
  console: app exec --interactive --reuse "bin/rails console"
  shell: app exec --interactive --reuse "/bin/bash"
  logs: app logs --since 1h --follow
